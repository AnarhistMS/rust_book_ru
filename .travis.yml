language: rust
rust: nightly

env:
  global:
    - secure: "n2UbieKa2git1BdLmmBPrdCgRP37cjmXC+aZq6zJc2c5s1MtuUjv0ohs2ta7IEJ/k05piakCRaYk8ulYlCecFQrdREnbIpYG8yPaqFd84S3vvV/elaV6SUSck8dLyaoLJSmpVwiUDOTZA1jbddqaFTjlV/UU3B8eRKb/E6rC4Z5tVbLUWScnSjWiEnt26DpKxqCnasQ1qzb4/gNWCGh9AH8FiZJSIc4YS1PznPHox76VRz6VTHQIad4gKvYg4HqrkLQWGt4HRuNV83bjCivPNRGYNwE4YZHKI/0/nS+o0gRAg+b+6XZxExsAuofGyqqFdryyLS9Z/5jDV3XaBKbpGKs9w3nfBz2IqVfTnJH2qCbLYaSXh+gZrH9o/3QzFjHpK330ZkDeYHLMDkbe2teJ3qM7lSlDf7dKYHrCTZi9jbk+FLxJ2X8Bh/OFouZLjU5b1kjlF15q6A5yoWc3eRJQTBTdlROKBtVv9q88T9Bs0OC98Dozj/x7oOapdb9+qUt6VpTblbZwUHGtMHRQ+XWAmLDWhxANj0yKtBpJRbDHtWPyl6LfZAQjTyTwrgYiXRuQUNjJ3bS2ivU1czcMsPAlBLDoTgd2Rsnsncf+b8lURiGo0IYU+CXtdnEHtju21XZh2e4T6NMZbGZjGyaXPCct79Ms725x/4xdVawOspFRwO8="

install:
  - source ./script/install_rustbook.sh
  - if [ $TRAVIS_PULL_REQUEST == "false" ] && [ $TRAVIS_BRANCH == "master" ]; then
      source ./script/install_calibre.sh;
    fi

before_script:
  - python --version
  - rustbook --version
  - if [ $TRAVIS_PULL_REQUEST == "false" ] && [ $TRAVIS_BRANCH == "master" ]; then
      ebook-convert --version;
    fi
  - ./script/fix.py
  - ./script/check.py

script:
  - ./script/build.sh

after_success:
  - if [ $TRAVIS_PULL_REQUEST == "false" ] && [ $TRAVIS_BRANCH == "master" ]; then
      ./script/convert.sh;
    fi
  - if [ $TRAVIS_PULL_REQUEST == "false" ] && [ $TRAVIS_BRANCH == "master" ]; then
      ./script/deploy.sh;
    fi

branches:
  only: master

notifications:
  webhooks:
    urls:
      - https://webhooks.gitter.im/e/9c2acdc270c9f1c84459
    on_success: change  # options: [always|never|change] default: always
    on_failure: always  # options: [always|never|change] default: always
    on_start: false     # default: false

cache:
  directories:
    - $HOME/calibre

addons:
  apt:
    packages:
    - parallel

